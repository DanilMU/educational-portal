# Процесс генерации PDF-сертификата

Этот документ описывает, как в системе происходит процесс создания и выдачи PDF-сертификата после успешного завершения курса.

## 1. Общая схема

Процесс состоит из двух основных этапов:

1.  **Создание записи о сертификате**: Когда администратор или модератор инициирует создание сертификата, система сначала проверяет, действительно ли пользователь завершил все уроки по данному предмету. Если да, в базе данных создается запись о сертификате.
2.  **Генерация и загрузка PDF**: Пользователь (или администратор) запрашивает загрузку сгенерированного PDF-файла по уникальному идентификатору сертификата.

---

## 2. Шаги процесса

### Шаг 1: Инициация создания сертификата

-   **Endpoint**: `POST /api/certificates`
-   **Кто**: Администратор или Модератор.
-   **Тело запроса**:
    ```json
    {
      "userId": "user-id-goes-here",
      "subjectId": "subject-id-goes-here"
    }
    ```
-   **Логика на сервере (`CertificatesService`):**
    1.  **Проверка предмета**: Система ищет предмет по `subjectId`.
    2.  **Проверка прогресса**: Система получает все уроки, связанные с этим предметом, и проверяет, есть ли у пользователя (`userId`) запись в `UserProgress` со статусом `isCompleted: true` для каждого из этих уроков.
    3.  **Предотвращение дубликатов**: Проверяется, не был ли уже выдан сертификат этому пользователю по этому предмету.
    4.  **Создание записи**: Если все проверки пройдены, в таблицу `Certificate` добавляется новая запись, содержащая `userId`, `subjectId`, дату выдачи (`issuedAt`) и URL для будущего доступа.

### Шаг 2: Генерация и загрузка PDF-файла

-   **Endpoint**: `GET /api/certificates/:id/download`
-   **Кто**: Владелец сертификата или Администратор.
-   **Логика на сервере (`CertificatesController` и `CertificatesService`):**
    1.  **Авторизация**: Система проверяет, что запрос делает либо владелец сертификата, либо администратор.
    2.  **Получение данных**: Из базы данных извлекаются данные о сертификате, включая имя и фамилию пользователя и название предмета.
    3.  **Генерация PDF с помощью `pdf-lib`**:
        -   Создается новый пустой PDF-документ.
        -   Добавляется страница стандартного размера (например, 600x400 пикселей).
        -   В документ встраивается шрифт (например, `Helvetica-Bold`).
        -   На страницу добавляется текст:
            -   Заголовок: "Certificate of Completion".
            -   Строка: "This is to certify that".
            -   Имя и фамилия пользователя.
            -   Строка: "has successfully completed the subject".
            -   Название предмета.
            -   Дата выдачи сертификата.
    4.  **Отправка файла**:
        -   Сгенерированный PDF-документ преобразуется в `Buffer`.
        -   Контроллер отправляет ответ с HTTP-заголовками:
            -   `Content-Type: application/pdf`
            -   `Content-Disposition: attachment; filename="certificate-ID.pdf"`
        -   Это заставляет браузер начать загрузку файла, а не отображать его.

---

## 3. Пример сгенерированного сертификата

Документ будет содержать следующий текст, отформатированный и расположенный по центру страницы:

```
--------------------------------------------------
|                                                |
|           Certificate of Completion            |
|                                                |
|           This is to certify that              |
|                                                |
|              [Имя Фамилия Пользователя]        |
|                                                |
|      has successfully completed the subject    |
|                                                |
|              [Название Предмета]               |
|                                                |
|           Issued on: [Дата выдачи]             |
|                                                |
--------------------------------------------------
```
